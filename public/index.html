<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sparq Dashboard</title>
    <script src="/portal/base-path.js"></script>
    <link rel="stylesheet" href="/portal/sparq-colors.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fb; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 14px; box-shadow: 0 20px 40px rgba(0,0,0,.05); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1a7ad9 0%, #0f5fb5 100%); color: #fff; padding: 24px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 6px; }
        .header p { opacity: .95; }
        .top-nav { display:flex; gap:8px; padding: 14px 18px; background:#fff; border-bottom:1px solid #e9ecef; align-items:center; flex-wrap:wrap; overflow-x:auto; justify-content:center; }
        .top-nav .nav-item { display:inline-flex; align-items:center; padding:10px 14px; margin:6px 4px; font-size:.98em; white-space:nowrap; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#333; box-shadow:0 1px 2px rgba(0,0,0,.04); transition:color .2s, background .2s, border-color .2s, transform .15s; cursor:pointer; }
        .top-nav .nav-item:hover { background:#f8fafc; border-color:#cbd5e1; color:#111; transform: translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,.06); }
        .top-nav .nav-item.active { background:#eff6ff; color:#1a7ad9; border-color:#1a7ad9; box-shadow:0 2px 6px rgba(26,120,216,.12); }
        .section { display:none; padding: 20px; }
        .section.active { display:block; }
        .card { background:#fff; border-radius: 10px; padding: 18px; margin: 14px 0; box-shadow: 0 1px 3px rgba(0,0,0,.06); border:1px solid #eef1f4; }
        .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 14px; margin: 12px 0; }
        .stat-card { background: linear-gradient(135deg, #da0c43 0%, #e41854 50%, #1a7ad9 100%); color:#fff; padding: 20px; border-radius: 10px; text-align:center; }
        .stat-number { font-size: 2.2em; font-weight: 800; margin-bottom: 6px; }
        .stat-label { opacity: .95; }
        .btn { background: #1a7ad9; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn:hover { filter: brightness(.95); }
        .btn-info { background:#17a2b8; }
        .btn-secondary { background:#6c757d; }
        .contacts-toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
        .contacts-input { flex:1; min-width:240px; padding:8px 10px; border:1px solid #e9ecef; border-radius:8px; }
        .contacts-select { padding:8px 10px; border:1px solid #e9ecef; border-radius:8px; }
        .contacts-table-wrap { overflow:auto; }
        .contacts-table { width:100%; border-collapse:collapse; }
        .contacts-head { text-align:left; border-bottom:1px solid #e9ecef; }
        .contacts-cell { padding:8px 6px; }
        .contacts-row { border-bottom:1px solid #f1f3f5; }
        .muted { color:#666; }
        .error { color:#c00; }
        .row-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sparq Dashboard</h1>
            <p>Account Management</p>
        </div>
        <div class="top-nav">
            <button class="nav-item active" data-target="dashboard">Dashboard</button>
            <button class="nav-item" data-target="create-domain">Create Domain Email</button>
            <button class="nav-item" data-target="manage-emails">Manage Emails</button>
            <button class="nav-item" data-target="storage">Storage</button>
            <button class="nav-item" data-target="dns-manager">DNS Manager</button>
            <button class="nav-item" data-target="client-portal">Client Portal</button>
            <button class="nav-item" data-target="system-logs">Debug Panel</button>
            <button class="nav-item" data-target="contacts">Contact Submissions</button>
            <button class="nav-item" data-target="settings">Settings</button>
        </div>

        <div class="content">
            <div id="dashboard" class="section active">
                <h2>System Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="total-domains">0</div><div class="stat-label">Active Domains</div></div>
                    <div class="stat-card"><div class="stat-number" id="total-emails">0</div><div class="stat-label">Email Accounts</div></div>
                    <div class="stat-card"><div class="stat-number" id="storage-used">0GB</div><div class="stat-label">Storage Used</div></div>
                    <div class="stat-card"><div class="stat-number" id="monthly-savings">$0</div><div class="stat-label">Monthly Savings</div></div>
                </div>
                <div class="card">
                    <h3>System Status</h3>
                    <div class="stats-grid" id="debug-status-grid">
                        <div class="stat-card"><div class="stat-number" id="dbg-postfix">—</div><div class="stat-label">Postfix (SMTP)</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg-dovecot">—</div><div class="stat-label">Dovecot (IMAP/SASL)</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg-nginx">—</div><div class="stat-label">Nginx</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg-dns">—</div><div class="stat-label">DNS</div></div>
                    </div>
                    <div class="row-actions">
                        <button class="btn btn-info" id="btn-run-diagnostics">Run Diagnostics</button>
                        <button class="btn btn-secondary" id="btn-copy-diagnostics">Copy Report</button>
                        <button class="btn" id="btn-refresh-logs">Refresh Logs</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="system-log-entries"></div>
                </div>
                <div class="card">
                    <h3>Diagnostic Details</h3>
                    <div id="diagnostic-results"><em>Click “Run Diagnostics” to populate detailed results.</em></div>
                </div>
            </div>

            <div id="system-logs" class="section">
                <h2>Debug Panel</h2>
                <div class="card">
                    <h3>Overview & Quick Checks</h3>
                    <p class="muted">Run diagnostics to evaluate core services and surface likely issues with actionable fixes.</p>
                    <div class="stats-grid" id="debug-status-grid-2">
                        <div class="stat-card"><div class="stat-number" id="dbg2-postfix">—</div><div class="stat-label">Postfix (SMTP)</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg2-dovecot">—</div><div class="stat-label">Dovecot (IMAP/SASL)</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg2-nginx">—</div><div class="stat-label">Nginx</div></div>
                        <div class="stat-card"><div class="stat-number" id="dbg2-dns">—</div><div class="stat-label">DNS</div></div>
                    </div>
                    <div class="row-actions">
                        <button class="btn btn-info" onclick="runDiagnostics()">Run Diagnostics</button>
                        <button class="btn btn-secondary" onclick="copyDiagnostics()">Copy Report</button>
                        <button class="btn" onclick="window.refreshLogs && window.refreshLogs()">Refresh Logs</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Diagnostic Details</h3>
                    <div id="diagnostic-results-2" class="muted"><em>Use the controls above to run checks.</em></div>
                </div>
            </div>

            <div id="contacts" class="section">
                <h2>Contact Submissions</h2>
                <div class="card">
                    <div class="contacts-toolbar">
                        <input id="contacts-filter" class="contacts-input" placeholder="Filter by site, email, subject, IP" />
                        <select id="contacts-limit" class="contacts-select" title="Result limit">
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                            <option value="200" selected>Last 200</option>
                            <option value="500">Last 500</option>
                        </select>
                        <button class="btn" id="contacts-refresh">Refresh</button>
                    </div>
                    <div class="contacts-table-wrap">
                        <table class="contacts-table">
                            <thead>
                                <tr class="contacts-head">
                                    <th class="contacts-cell">When</th>
                                    <th class="contacts-cell">Site</th>
                                    <th class="contacts-cell">From</th>
                                    <th class="contacts-cell">Email</th>
                                    <th class="contacts-cell">Subject</th>
                                    <th class="contacts-cell">To</th>
                                    <th class="contacts-cell">IP</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="section">
                <h2>System Settings</h2>
                <div class="card">
                    <h3>Email Server Configuration</h3>
                    <div class="stats-grid" aria-label="Server configuration">
                        <label class="card">
                            <span>Server IP</span>
                            <input type="text" value="68.54.208.207" readonly title="Server IP" />
                        </label>
                        <label class="card">
                            <span>Default Storage per Domain</span>
                            <select title="Default storage per domain">
                                <option value="25" selected>25GB</option>
                                <option value="50">50GB</option>
                                <option value="100">100GB</option>
                            </select>
                        </label>
                        <label class="card">
                            <span>Auto-generate Password Length</span>
                            <input type="number" value="12" min="8" max="32" title="Password length" />
                        </label>
                    </div>
                    <div class="row-actions"><button class="btn btn-success">Save Settings</button></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/portal/admin-dashboard.js"></script>
    <script src="/portal/shared-header-nav.js"></script>
    <script src="/portal/storage-manager.js"></script>
    <script>
    (function(){
        const $ = (id) => document.getElementById(id);
        async function candidateFetch(paths, init){
            const cands = [];
            (paths||[]).forEach(p=>{ const clean = p.startsWith('/')? p : '/'+p; cands.push(clean); if (!clean.startsWith('/portal/')) cands.push('/portal'+clean); try{ if (typeof window.__withBase__==='function') cands.push(window.__withBase__(clean.replace(/^\//,''))); }catch(_){ } });
            let lastErr; for (const url of cands){ try{ const r = await fetch(url, init); if (r.ok) return r; lastErr = new Error('HTTP '+r.status); } catch(e){ lastErr = e; } } throw lastErr || new Error('All candidates failed');
        }
        async function fetchJSON(paths){ const r = await candidateFetch(paths, { credentials:'include', headers:{'Accept':'application/json'} }); return r.json(); }

        // Nav
        document.querySelectorAll('.top-nav .nav-item').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                e.preventDefault();
                const id = btn.getAttribute('data-target');
                const withBase = (p)=>{ try{ return (typeof window.__withBase__==='function') ? window.__withBase__(p.replace(/^\//,'')) : p; }catch(_){ return p; } };
                // Redirect or action for items without on-page sections
                if (id === 'manage-emails') { window.location.assign(withBase('/portal/email-manager.html')); return; }
                if (id === 'create-domain') { window.location.assign(withBase('/portal/create-domain.html')); return; }
                if (id === 'dns-manager') { window.location.assign(withBase('/portal/dns-manager.html')); return; }
                if (id === 'client-portal') { window.open('https://sparqplug.getsparqd.com', '_blank', 'noopener'); return; }
                if (id === 'storage') { try { window.StorageManager && window.StorageManager.open(); } catch(_){} return; }
                document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
                document.getElementById(id)?.classList.add('active');
                document.querySelectorAll('.top-nav .nav-item').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                try { history.replaceState(null, '', '#'+id); } catch(_){ }
                if (id === 'contacts') loadContacts();
            });
        });
        if (location.hash){ const id = location.hash.replace('#',''); const btn = document.querySelector(`.top-nav .nav-item[data-target=\"${id}\"]`); if (btn) btn.click(); }

        // Diagnostics glue
        function setDbg(id, ok){ const el=$(id); if (el) el.textContent = ok? 'OK' : '—'; }
        function renderDiagnostic(results){ const wrap=$('diagnostic-results'); if (!wrap) return; const rows=[]; const row=(n,ok,why,fix,extra)=>{ rows.push(`<div><strong>${n}:</strong> ${ok? 'OK':'Issue'}${why? ' — '+why:''}${fix? ' | Fix: '+fix:''}${extra? ' | '+extra:''}</div>`); }; row('Postfix',results.postfix.ok,results.postfix.reason,results.postfix.fix); row('Dovecot',results.dovecot.ok,results.dovecot.reason,results.dovecot.fix); row('Nginx',results.nginx.ok,results.nginx.reason,results.nginx.fix); row('DNS',results.dns.ok,results.dns.reason,results.dns.fix); if (results.portal) row('Portal',results.portal.ok,results.portal.reason,results.portal.fix,results.portal.extra); wrap.innerHTML = rows.join(''); }
        async function runDiagnostics(){ const results={ postfix:{ok:false}, dovecot:{ok:false}, nginx:{ok:false}, dns:{ok:false}, portal:{ok:true} }; try{ const h = await fetchJSON(['/healthz','/api/health','/gateway/health','/api/sparqy/health']); const val=(k,def=false)=> (typeof h?.[k]==='boolean')? h[k] : def; results.postfix.ok=val('postfix',true); results.dovecot.ok=val('dovecot',true); results.nginx.ok=val('nginx',true); const dnsOk = (h&&h.dns&&typeof h.dns.ok==='boolean')? h.dns.ok : val('dns',true); results.dns.ok = dnsOk; }catch(_){ results.portal = { ok:false, reason:'Portal health endpoint not reachable', fix:'Ensure portal is running and reverse proxy forwards /healthz.' }; } setDbg('dbg-postfix',!!results.postfix.ok); setDbg('dbg-dovecot',!!results.dovecot.ok); setDbg('dbg-nginx',!!results.nginx.ok); setDbg('dbg-dns',!!results.dns.ok); renderDiagnostic(results); setDbg('dbg2-postfix',!!results.postfix.ok); setDbg('dbg2-dovecot',!!results.dovecot.ok); setDbg('dbg2-nginx',!!results.nginx.ok); setDbg('dbg2-dns',!!results.dns.ok); const wrap2=$('diagnostic-results-2'); if (wrap2) wrap2.innerHTML = $('diagnostic-results')?.innerHTML || ''; }
        async function copyDiagnostics(){ try{ const el=$('diagnostic-results'); const text = el? el.innerText : 'No diagnostics yet.'; await navigator.clipboard.writeText(text); alert('Diagnostics copied'); } catch(_){ alert('Could not copy diagnostics'); } }
        window.runDiagnostics = runDiagnostics;
        window.copyDiagnostics = copyDiagnostics;
        $('btn-run-diagnostics')?.addEventListener('click', runDiagnostics);
        $('btn-copy-diagnostics')?.addEventListener('click', copyDiagnostics);
        $('btn-refresh-logs')?.addEventListener('click', ()=> window.refreshLogs && window.refreshLogs());

        // Contacts loader
        async function loadContacts(){ const body=$('contacts-body'); if (!body) return; const limEl=$('contacts-limit'); const filter = ($('contacts-filter')?.value || '').toLowerCase(); const lim = limEl ? Number(limEl.value||200) : 200; body.innerHTML = '<tr><td class="contacts-cell muted" colspan="7">Loading…</td></tr>'; try{ const data = await fetchJSON([`/api/contacts/submissions?limit=${lim}`]); const list = (data && data.submissions) || []; const rows=[]; list.forEach(r=>{ const when = r.at ? new Date(r.at).toLocaleString() : ''; const site = r.routingKey || ''; const from = r.name || ''; const email = r.email || ''; const subj = r.subject || ''; const to = r.to || ''; const ip = r.ip || ''; const hay = [when, site, from, email, subj, to, ip].join(' ').toLowerCase(); if (filter && !hay.includes(filter)) return; rows.push(`<tr class=\"contacts-row\"><td class=\"contacts-cell\">${when}</td><td class=\"contacts-cell\">${site}</td><td class=\"contacts-cell\">${from}</td><td class=\"contacts-cell\">${email}</td><td class=\"contacts-cell\">${subj}</td><td class=\"contacts-cell\">${to}</td><td class=\"contacts-cell\">${ip}</td></tr>`); }); body.innerHTML = rows.length ? rows.join('') : '<tr><td class=\"contacts-cell muted\" colspan=\"7\">No submissions found.</td></tr>'; } catch(_){ body.innerHTML = '<tr><td class=\"contacts-cell error\" colspan=\"7\">Failed to load submissions.</td></tr>'; } }
        $('contacts-refresh')?.addEventListener('click', loadContacts);
        $('contacts-filter')?.addEventListener('input', ()=>{ clearTimeout(window.__cf_to); window.__cf_to = setTimeout(loadContacts, 200); });
        $('contacts-limit')?.addEventListener('change', loadContacts);
        if (location.hash === '#contacts') loadContacts();

        // Title/header enforcement
        (function(){ const DESIRED='Sparq Dashboard'; function enforce(){ try{ if (document.title!==DESIRED) document.title=DESIRED; const h1=document.querySelector('.header h1'); if (h1 && h1.textContent.trim()!==DESIRED) h1.textContent=DESIRED; }catch(_){ } } enforce(); document.addEventListener('DOMContentLoaded', enforce); window.addEventListener('load', enforce); window.addEventListener('hashchange', enforce); })();
    })();
    </script>
</body>
</html>
